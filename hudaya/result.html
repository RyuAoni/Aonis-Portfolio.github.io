<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ゲーム結果</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center p-4 sm:p-8 font-sans">

    <div class="w-full max-w-4xl p-6 sm:p-8 space-y-8 bg-gray-800 rounded-lg shadow-2xl border border-gray-700">
        
        <!-- 今回のゲーム結果 -->
        <div class="text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-indigo-400">ゲーム結果</h1>
            <div id="game-result-list" class="mt-4 text-lg space-y-2">
                <!-- JSで動的に追加 -->
                <p>結果を読み込み中...</p>
            </div>
        </div>
        
        <hr class="border-gray-600">

        <!-- 総合ランキング -->
        <div>
            <h2 class="text-2xl sm:text-3xl font-bold text-center text-yellow-400 mb-4">総合ランキング</h2>
            <div class="overflow-x-auto bg-gray-900 rounded-lg p-4">
                <table class="w-full text-left">
                    <thead>
                        <tr class="border-b border-gray-600">
                            <th class="p-2 sm:p-3 w-1/6">順位</th>
                            <th class="p-2 sm:p-3 w-3/6">プレイヤー</th>
                            <th class="p-2 sm:p-3 w-2/6 text-right">累計スコア</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-body">
                        <!-- JSで動的に追加 -->
                        <tr><td colspan="3" class="p-4 text-center">ランキングを読み込み中...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- アクションボタン -->
        <div class="flex flex-col sm:flex-row gap-4 mt-8">
            <a href="new_game.html" class="w-full text-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                新しいゲームを作成 (GM)
            </a>
            <a href="home.html" class="w-full text-center py-3 px-4 border border-gray-500 rounded-md shadow-sm text-lg font-medium text-white bg-gray-600 hover:bg-gray-700">
                ホームに戻る
            </a>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            if (!token) {
                // FIX: Use an absolute URL for redirection
                window.location.href = window.location.origin + '/login.html';
                return;
            }

            // 1. 今回のゲーム結果をlocalStorageから表示
            const gameResultList = document.getElementById('game-result-list');
            const resultsData = localStorage.getItem('gameResults');
            if (resultsData) {
                const results = JSON.parse(resultsData);
                // 点数でソート
                results.sort((a, b) => b.score - a.score);
                
                gameResultList.innerHTML = '';
                results.forEach((player, index) => {
                    const p = document.createElement('p');
                    p.innerHTML = `<span class="font-bold">${index + 1}位:</span> ${player.nickname} <span class="text-yellow-400">${player.score}点</span>`;
                    gameResultList.appendChild(p);
                });
                localStorage.removeItem('gameResults'); // 表示後は削除
            } else {
                gameResultList.innerHTML = '<p>今回のゲーム結果はありません。</p>';
            }

            // 2. サーバーから総合ランキングを取得して表示
            const rankingBody = document.getElementById('ranking-body');
            fetch('/api/rankings', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    rankingBody.innerHTML = '';
                    if (data.rankings.length > 0) {
                        data.rankings.forEach((player, index) => {
                            const tr = document.createElement('tr');
                            tr.className = 'border-b border-gray-700';
                            tr.innerHTML = `
                                <td class="p-2 sm:p-3 font-bold">${index + 1}</td>
                                <td class="p-2 sm:p-3">${player.nickname || '名無し'}</td>
                                <td class="p-2 sm:p-3 text-right text-yellow-400 font-mono">${player.total_score}</td>
                            `;
                            rankingBody.appendChild(tr);
                        });
                    } else {
                        rankingBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center">まだ誰もプレイしていません。</td></tr>';
                    }
                } else {
                    throw new Error(data.message);
                }
            })
            .catch(err => {
                console.error('Ranking fetch error:', err);
                rankingBody.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-red-400">ランキングの読み込みに失敗しました。</td></tr>`;
            });
        });
    </script>
</body>
</html>

